<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AurumTrade</title>
    <style>
        /* (взято из твоего стиля) */
        body { margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#0b0e11; color:#f0b90b; }
        .header{font-size:1.2rem;font-weight:bold;color:#f0b90b;padding:15px 20px;position:relative;display:flex;justify-content:space-between;align-items:center;}
        .header .title{user-select:none;}
        .header .profile-btn{cursor:pointer;background:#f0b90b;color:#0b0e11;border:none;border-radius:8px;padding:8px 15px;font-weight:bold;}
        #loginScreen,#workScreen{height:100vh;background:#0b0e11;display:flex;justify-content:center;align-items:center;flex-direction:column;color:white;}
        #loginScreen{display:flex;} #workScreen{display:none;flex-direction:column;padding:20px;}
        .tabs{display:flex;gap:10px;margin-bottom:15px;}
        .tab{cursor:pointer;padding:10px 20px;background:#1e2329;border-radius:8px 8px 0 0;border:1px solid #f0b90b;border-bottom:none;color:#f0b90b;font-weight:bold;}
        .tab.active{background:#f0b90b;color:#0b0e11;}
        .tab-content{background:#1e2329;padding:20px;border:1px solid #f0b90b;border-radius:0 8px 8px 8px;width:600px;max-width:90vw;color:#f0b90b;display:none;}
        .tab-content.active{display:block;}
        .login-box{background:#1e2329;padding:30px;border-radius:15px;width:320px;text-align:center;border:1px solid #f0b90b;}
        .login-box input{width:90%;padding:12px;margin:10px 0;border:1px solid #f0b90b;border-radius:8px;background:#0b0e11;color:white;}
        .login-box button{width:95%;padding:12px;background:#f0b90b;color:#0b0e11;border:none;border-radius:8px;font-size:1.1rem;cursor:pointer;margin-top:5px;}
        .status-message{font-size:1.4rem;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
        .nickname-input{width:60%;padding:15px;font-size:1.2rem;border-radius:8px;border:1px solid #f0b90b;background:#1e2329;color:white;}
        .buttons{margin-top:15px;display:flex;gap:10px;}
        .btn{padding:12px 20px;font-size:1.1rem;border:none;border-radius:8px;cursor:pointer;}
        .btn-check{background:#f0b90b;color:#0b0e11;}
        .btn-history{background:#1e2329;color:#f0b90b;border:1px solid #f0b90b;}
        .history-box{margin-top:20px;background:#1e2329;padding:15px;border-radius:8px;max-width:60%;width:100%;max-height:200px;overflow-y:auto;color:#f0b90b;}
        .report-form label{display:block;margin-top:10px;font-weight:bold;}
        .report-form input[type="date"], .report-form input[type="number"], .report-form input[type="text"]{width:100%;padding:8px;font-size:1rem;border-radius:6px;border:1px solid #f0b90b;background:#0b0e11;color:white;margin-top:5px;}
        .report-form button{margin-top:15px;background:#f0b90b;color:#0b0e11;border:none;padding:12px 20px;font-weight:bold;border-radius:8px;cursor:pointer;font-size:1.1rem;width:100%;}
        .report-list{margin-top:20px;max-height:300px;overflow-y:auto;background:#1e2329;border-radius:8px;padding:10px;color:#f0b90b;font-size:0.95rem;width:600px;max-width:90vw;}
        table{width:100%;border-collapse:collapse;}
        th,td{border:1px solid #f0b90b;padding:6px 10px;text-align:center;}
        th{background:#f0b90b;color:#0b0e11;}
        .error-message{color:#f44336;margin-top:8px;font-weight:bold;}
    </style>
</head>
<body>

<div class="header">
    <div class="title">AurumTrade</div>
    <button id="profileBtn" class="profile-btn" style="display:none">Личный кабинет</button>
</div>

<div id="loginScreen">
    <div class="login-box">
        <h2>Вход в систему</h2>
        <input id="loginInput" type="text" placeholder="Логин" />
        <input id="passwordInput" type="password" placeholder="Пароль" />
        <button id="loginBtn">Войти</button>
        <div id="loginError" class="error-message"></div>
    </div>
</div>

<div id="workScreen" style="display:none; flex-direction: column; align-items: center;">

    <div class="tabs">
        <div id="tabCheck" class="tab active">Проверка ников</div>
        <div id="tabReports" class="tab">Отчеты</div>
    </div>

    <div id="tabCheckContent" class="tab-content active">
        <div class="status-message">
            <span id="statusText">Введите ник</span>
        </div>
        <input id="nickInput" type="text" class="nickname-input" placeholder="Введите никнейм" />
        <div class="buttons">
            <button id="checkBtn" class="btn btn-check">Проверить</button>
            <button id="historyBtn" class="btn btn-history">История</button>
        </div>
        <div id="historyBox" class="history-box" style="display:none;"></div>
    </div>

    <div id="tabReportsContent" class="tab-content">
        <form id="reportForm" class="report-form" autocomplete="off">
            <label for="dateInput">Дата</label>
            <input id="dateInput" name="date" type="date" max="" required />
            <label for="aktivInput">Актив</label>
            <input id="aktivInput" name="aktiv" type="number" min="0" required />
            <label for="novyeInput">Новые</label>
            <input id="novyeInput" name="novye" type="number" min="0" required />
            <label for="vbrosyInput">Вбросы</label>
            <input id="vbrosyInput" name="vbrosy" type="number" min="0" required />
            <label for="predlogiInput">Предлоги</label>
            <input id="predlogiInput" name="predlogi" type="number" min="0" required />
            <label for="soglasyInput">Согласы</label>
            <input id="soglasyInput" name="soglasy" type="number" min="0" required />
            <label for="lidiInput">Лиды</label>
            <input id="lidiInput" name="lidi" type="number" min="0" required />
            <label for="depozityInput">Депозиты</label>
            <input id="depozityInput" name="depozity" type="number" min="0" required />
            <label for="managerInput">Менеджер</label>
            <input id="managerInput" name="manager" type="text" required />
            <button type="submit">Отправить</button>
            <div id="reportError" class="error-message"></div>
            <div id="reportSuccess" style="color:#4CAF50; margin-top: 8px; font-weight: bold;"></div>
        </form>
        <div id="reportList" class="report-list" style="display:none;">
            <h3>Отчеты</h3>
            <table>
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Менеджер</th>
                        <th>Актив</th>
                        <th>Новые</th>
                        <th>Вбросы</th>
                        <th>Предлоги</th>
                        <th>Согласы</th>
                        <th>Лиды</th>
                        <th>Депозиты</th>
                        <th>Время отправки</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    let accessToken = null;
    let currentUser = null;

    const loginScreen = document.getElementById('loginScreen');
    const workScreen = document.getElementById('workScreen');
    const loginBtn = document.getElementById('loginBtn');
    const loginInput = document.getElementById('loginInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginError = document.getElementById('loginError');
    const profileBtn = document.getElementById('profileBtn');

    const nickInput = document.getElementById('nickInput');
    const checkBtn = document.getElementById('checkBtn');
    const historyBtn = document.getElementById('historyBtn');
    const statusText = document.getElementById('statusText');
    const historyBox = document.getElementById('historyBox');

    const tabCheck = document.getElementById('tabCheck');
    const tabReports = document.getElementById('tabReports');
    const tabCheckContent = document.getElementById('tabCheckContent');
    const tabReportsContent = document.getElementById('tabReportsContent');

    const reportForm = document.getElementById('reportForm');
    const dateInput = document.getElementById('dateInput');
    const aktivInput = document.getElementById('aktivInput');
    const novyeInput = document.getElementById('novyeInput');
    const vbrosyInput = document.getElementById('vbrosyInput');
    const predlogiInput = document.getElementById('predlogiInput');
    const soglasyInput = document.getElementById('soglasyInput');
    const lidiInput = document.getElementById('lidiInput');
    const depozityInput = document.getElementById('depozityInput');
    const managerInput = document.getElementById('managerInput');
    const reportError = document.getElementById('reportError');
    const reportSuccess = document.getElementById('reportSuccess');
    const reportList = document.getElementById('reportList');
    const reportTableBody = document.getElementById('reportTableBody');

    function setMaxDate() {
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('max', today);
        dateInput.value = today;
    }
    setMaxDate();

    loginBtn.addEventListener('click', async () => {
        loginError.textContent = "";
        const username = loginInput.value.trim();
        const password = passwordInput.value.trim();
        if (!username || !password) {
            loginError.textContent = "Введите логин и пароль";
            return;
        }
        try {
            const response = await fetch('/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ username, password })
            });
            if (!response.ok) {
                const data = await response.json();
                loginError.textContent = data.detail || "Ошибка входа";
                return;
            }
            const data = await response.json();
            accessToken = data.access_token;
            currentUser = username;
            loginScreen.style.display = "none";
            workScreen.style.display = "flex";
            profileBtn.style.display = "inline-block";

            if (currentUser === "admin") {
                reportList.style.display = "block";
                loadReports();
                tabReports.style.display = "inline-block";
            } else {
                tabReports.style.display = "inline-block";
                reportList.style.display = "none";
            }
        } catch (e) {
            loginError.textContent = "Ошибка сети";
        }
    });

    tabCheck.addEventListener('click', () => {
        tabCheck.classList.add('active');
        tabReports.classList.remove('active');
        tabCheckContent.classList.add('active');
        tabReportsContent.classList.remove('active');
        reportError.textContent = "";
        reportSuccess.textContent = "";
    });
    tabReports.addEventListener('click', () => {
        tabReports.classList.add('active');
        tabCheck.classList.remove('active');
        tabReportsContent.classList.add('active');
        tabCheckContent.classList.remove('active');
        statusText.textContent = "Введите ник";
        historyBox.style.display = "none";
    });

    checkBtn.addEventListener('click', async () => {
        statusText.textContent = "Проверка...";
        const nick = nickInput.value.trim();
        if (!nick) {
            statusText.textContent = "Введите никнейм";
            return;
        }
        try {
            const response = await fetch('/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                body: JSON.stringify({ nicknames: [nick] })
            });
            if (!response.ok) {
                statusText.textContent = "Ошибка сервера";
                return;
            }
            const data = await response.json();
            const res = data.results[0];
            statusText.textContent = `${res.nickname}: ${res.status}`;
        } catch (e) {
            statusText.textContent = "Ошибка сети";
        }
    });

    historyBtn.addEventListener('click', async () => {
        historyBox.style.display = "block";
        historyBox.textContent = "Загрузка...";
        try {
            const response = await fetch('/history', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) {
                historyBox.textContent = "Ошибка загрузки истории";
                return;
            }
            const data = await response.json();
            if (data.length === 0) {
                historyBox.textContent = "История пуста";
                return;
            }
            historyBox.innerHTML = data.map(line => `<div>${line}</div>`).join('');
        } catch (e) {
            historyBox.textContent = "Ошибка сети";
        }
    });

    reportForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        reportError.textContent = "";
        reportSuccess.textContent = "";

        const selectedDate = new Date(dateInput.value);
        const now = new Date();
        now.setHours(0,0,0,0);
        if (selectedDate > now) {
            reportError.textContent = "Дата не может быть в будущем";
            return;
        }

        const payload = {
            date: dateInput.value,
            aktiv: parseInt(aktivInput.value) || 0,
            novye: parseInt(novyeInput.value) || 0,
            vbrosy: parseInt(vbrosyInput.value) || 0,
            predlogi: parseInt(predlogiInput.value) || 0,
            soglasy: parseInt(soglasyInput.value) || 0,
            lidi: parseInt(lidiInput.value) || 0,
            depozity: parseInt(depozityInput.value) || 0,
            manager: managerInput.value.trim()
        };

        try {
            const response = await fetch('/report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const data = await response.json();
                reportError.textContent = data.detail || "Ошибка отправки отчёта";
                return;
            }
            reportSuccess.textContent = "Отчёт успешно отправлен";
            reportForm.reset();
            setMaxDate();

            if (currentUser === "admin") {
                loadReports();
            }
        } catch (e) {
            reportError.textContent = "Ошибка сети";
        }
    });

    async function loadReports() {
        try {
            const response = await fetch('/reports', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) {
                reportList.style.display = "none";
                return;
            }
            const data = await response.json();
            if (data.length === 0) {
                reportTableBody.innerHTML = '<tr><td colspan="10">Отчётов нет</td></tr>';
                return;
            }
            reportTableBody.innerHTML = data.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.manager}</td>
                    <td>${r.aktiv}</td>
                    <td>${r.novye}</td>
                    <td>${r.vbrosy}</td>
                    <td>${r.predlogi}</td>
                    <td>${r.soglasy}</td>
                    <td>${r.lidi}</td>
                    <td>${r.depozity}</td>
                    <td>${r.timestamp}</td>
                </tr>
            `).join('');
        } catch (e) {
            reportList.style.display = "none";
        }
    }
</script>

</body>
</html>
